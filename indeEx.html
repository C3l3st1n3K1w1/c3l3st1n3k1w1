<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Coffee Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --coffee-bg: #2b211c;
      --coffee-card: #3a2a23;
      --coffee-accent: #c89b6d;
      --coffee-accent-soft: #e3c3a1;
      --coffee-text: #f7f0e9;
      --coffee-muted: #b9a89a;
      --danger: #ff6b6b;
      --success: #4caf50;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #4b3427, #1b130f);
      color: var(--coffee-text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 16px;
    }

    .app-shell {
      width: 100%;
      max-width: 1100px;
      background: rgba(20, 12, 9, 0.9);
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.2fr);
      overflow: hidden;
      border: 1px solid rgba(200, 155, 109, 0.35);
    }

    @media (max-width: 900px) {
      .app-shell {
        grid-template-columns: 1fr;
      }
    }

    .left-pane {
      padding: 18px 18px 16px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      border-right: 1px solid rgba(200, 155, 109, 0.25);
    }

    @media (max-width: 900px) {
      .left-pane {
        border-right: none;
        border-bottom: 1px solid rgba(200, 155, 109, 0.25);
      }
    }

    .right-pane {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: radial-gradient(circle at top, #3a2720, #140c09);
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #f7f0e9, #c89b6d);
      box-shadow: 0 0 0 2px rgba(200, 155, 109, 0.5);
      position: relative;
    }

    .brand-logo::before {
      content: "";
      position: absolute;
      inset: 7px;
      border-radius: 50%;
      border: 2px solid rgba(43, 33, 28, 0.8);
    }

    .brand-text-main {
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 0.9rem;
    }

    .brand-text-sub {
      font-size: 0.7rem;
      color: var(--coffee-muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .status-pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(200, 155, 109, 0.5);
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--coffee-accent-soft);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--danger);
      box-shadow: 0 0 6px rgba(255, 107, 107, 0.8);
    }

    .status-dot.online {
      background: var(--success);
      box-shadow: 0 0 6px rgba(76, 175, 80, 0.8);
    }

    .device-pill {
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(200, 155, 109, 0.4);
      font-size: 0.7rem;
      color: var(--coffee-muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .device-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--coffee-accent);
    }

    .main-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.2fr);
      gap: 12px;
      flex: 1;
      min-height: 0;
    }

    @media (max-width: 700px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
    }

    .game-card {
      background: radial-gradient(circle at top left, #4b3427, #241712);
      border-radius: 14px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      border: 1px solid rgba(200, 155, 109, 0.35);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.6);
      position: relative;
      overflow: hidden;
    }

    .game-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .game-title {
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .game-subtitle {
      font-size: 0.7rem;
      color: var(--coffee-muted);
    }

    .game-mode-pill {
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(200, 155, 109, 0.4);
      font-size: 0.7rem;
      color: var(--coffee-accent-soft);
    }

    .game-canvas-wrapper {
      flex: 1;
      min-height: 220px;
      border-radius: 10px;
      overflow: hidden;
      background: #120b08;
      border: 1px solid rgba(200, 155, 109, 0.3);
      position: relative;
    }

    canvas {
      width: 100%;
      height: 100%;
      display: block;
      background: radial-gradient(circle at top, #3b261c, #120b08);
    }

    .game-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.75rem;
      color: var(--coffee-muted);
    }

    .game-footer-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tiny-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--coffee-accent);
    }

    .game-footer-right {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pill-soft {
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(200, 155, 109, 0.3);
    }

    .menu-card {
      background: radial-gradient(circle at top right, #4b3427, #241712);
      border-radius: 14px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border: 1px solid rgba(200, 155, 109, 0.35);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.6);
      position: relative;
      overflow: hidden;
    }

    .menu-tabs {
      display: flex;
      gap: 6px;
      font-size: 0.75rem;
    }

    .menu-tab {
      flex: 1;
      text-align: center;
      padding: 6px 8px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid transparent;
      cursor: pointer;
      color: var(--coffee-muted);
      user-select: none;
    }

    .menu-tab.active {
      background: rgba(200, 155, 109, 0.16);
      border-color: rgba(200, 155, 109, 0.7);
      color: var(--coffee-accent-soft);
      font-weight: 600;
    }

    .menu-section {
      display: none;
      flex-direction: column;
      gap: 8px;
      font-size: 0.8rem;
    }

    .menu-section.active {
      display: flex;
    }

    .field-label {
      font-size: 0.75rem;
      color: var(--coffee-muted);
      margin-bottom: 2px;
    }

    .text-input,
    .select-input {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid rgba(200, 155, 109, 0.4);
      background: rgba(10, 6, 4, 0.9);
      color: var(--coffee-text);
      font-size: 0.8rem;
      outline: none;
    }

    .text-input:focus,
    .select-input:focus {
      border-color: rgba(200, 155, 109, 0.9);
      box-shadow: 0 0 0 1px rgba(200, 155, 109, 0.5);
    }

    .button-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .btn {
      flex: 1;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(200, 155, 109, 0.6);
      background: linear-gradient(135deg, #c89b6d, #8b5a33);
      color: #1b130f;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      user-select: none;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.12s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.6);
      background: linear-gradient(135deg, #ddb48a, #9c6437);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .btn-secondary {
      background: rgba(0, 0, 0, 0.4);
      color: var(--coffee-accent-soft);
      border-color: rgba(200, 155, 109, 0.4);
    }

    .btn-secondary:hover {
      background: rgba(0, 0, 0, 0.7);
    }

    .rooms-list {
      max-height: 150px;
      overflow-y: auto;
      border-radius: 8px;
      border: 1px solid rgba(200, 155, 109, 0.3);
      background: rgba(10, 6, 4, 0.9);
      padding: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .room-item {
      padding: 6px 8px;
      border-radius: 6px;
      background: rgba(200, 155, 109, 0.08);
      border: 1px solid rgba(200, 155, 109, 0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      font-size: 0.75rem;
    }

    .room-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .room-name {
      font-weight: 600;
      color: var(--coffee-accent-soft);
    }

    .room-sub {
      color: var(--coffee-muted);
      font-size: 0.7rem;
    }

    .room-join-btn {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(200, 155, 109, 0.7);
      background: rgba(200, 155, 109, 0.16);
      color: var(--coffee-accent-soft);
      font-size: 0.7rem;
      cursor: pointer;
      user-select: none;
    }

    .room-join-btn:hover {
      background: rgba(200, 155, 109, 0.3);
    }

    .empty-state {
      font-size: 0.75rem;
      color: var(--coffee-muted);
      text-align: center;
      padding: 10px 4px;
    }

    .log-panel {
      flex: 1;
      border-radius: 10px;
      border: 1px solid rgba(200, 155, 109, 0.3);
      background: rgba(10, 6, 4, 0.9);
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.75rem;
    }

    .log-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--coffee-muted);
    }

    .log-body {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .log-line {
      color: var(--coffee-muted);
      font-size: 0.72rem;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .log-line-strong {
      color: var(--coffee-accent-soft);
    }

    .tag {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(200, 155, 109, 0.4);
      font-size: 0.65rem;
      color: var(--coffee-muted);
    }

    .chat-input-row {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .chat-input {
      flex: 1;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(200, 155, 109, 0.4);
      background: rgba(10, 6, 4, 0.9);
      color: var(--coffee-text);
      font-size: 0.75rem;
      outline: none;
    }

    .chat-input:focus {
      border-color: rgba(200, 155, 109, 0.9);
      box-shadow: 0 0 0 1px rgba(200, 155, 109, 0.5);
    }

    .floating-card {
      position: absolute;
      right: 16px;
      bottom: 16px;
      width: 220px;
      border-radius: 14px;
      background: radial-gradient(circle at top, #4b3427, #241712);
      border: 1px solid rgba(200, 155, 109, 0.4);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.7);
      padding: 10px;
      font-size: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 6px;
      pointer-events: none;
    }

    @media (max-width: 900px) {
      .floating-card {
        display: none;
      }
    }

    .floating-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--coffee-accent-soft);
    }

    .floating-body {
      color: var(--coffee-muted);
      font-size: 0.72rem;
    }

    .floating-tag-row {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .badge {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(200, 155, 109, 0.4);
      font-size: 0.65rem;
      color: var(--coffee-accent-soft);
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="left-pane">
      <div class="header-row">
        <div class="brand">
          <div class="brand-logo"></div>
          <div>
            <div class="brand-text-main">Coffee Game</div>
            <div class="brand-text-sub">Multiplayer Roast</div>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end;">
          <div class="status-pill" id="connectionStatus">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Offline</span>
          </div>
          <div class="device-pill" id="devicePill">
            <span class="device-dot"></span>
            <span id="deviceLabel">Detecting device…</span>
          </div>
        </div>
      </div>

      <div class="main-layout">
        <div class="game-card">
          <div class="game-card-header">
            <div>
              <div class="game-title" id="gameTitle">Lobby Canvas</div>
              <div class="game-subtitle">Waiting for host / join events</div>
            </div>
            <div class="game-mode-pill" id="roomModePill">No Room</div>
          </div>
          <div class="game-canvas-wrapper">
            <canvas id="gameCanvas"></canvas>
          </div>
          <div class="game-footer">
            <div class="game-footer-left">
              <div class="tiny-dot"></div>
              <span id="roomInfo">Not in a room</span>
            </div>
            <div class="game-footer-right">
              <div class="pill-soft" id="playerCountPill">Players: 0</div>
              <div class="pill-soft" id="pingPill">Ping: —</div>
            </div>
          </div>
        </div>

        <div class="menu-card">
          <div class="menu-tabs">
            <div class="menu-tab active" data-tab="host">Host</div>
            <div class="menu-tab" data-tab="join">Join</div>
            <div class="menu-tab" data-tab="settings">Settings</div>
          </div>

          <div class="menu-section active" id="section-host">
            <div>
              <div class="field-label">Room name</div>
              <input id="hostRoomName" class="text-input" placeholder="e.g. Rin's Roast" />
            </div>
            <div>
              <div class="field-label">Game</div>
              <select id="hostGameSelect" class="select-input">
                <option value="snake">Snake (Coffee Grounds)</option>
                <option value="tetris">Tetris (Falling Beans)</option>
                <option value="pacman">Pac-Man (Bean Hunt)</option>
                <option value="chess">Chess (Espresso Gambit)</option>
                <option value="connect4">Connect 4 (Drip Stack)</option>
                <option value="tictactoe">Tic Tac Toe (Latte Grid)</option>
              </select>
            </div>
            <div class="button-row">
              <button class="btn" id="hostBtn">Host Room</button>
              <button class="btn btn-secondary" id="leaveBtn" disabled>Leave</button>
            </div>
          </div>

          <div class="menu-section" id="section-join">
            <div class="button-row">
              <button class="btn" id="refreshRoomsBtn">Refresh Rooms</button>
            </div>
            <div class="rooms-list" id="roomsList">
              <div class="empty-state" id="roomsEmptyState">No rooms yet. Host one on the left.</div>
            </div>
          </div>

          <div class="menu-section" id="section-settings">
            <div>
              <div class="field-label">Display name</div>
              <input id="displayNameInput" class="text-input" placeholder="Your name in the lobby" />
            </div>
            <div>
              <div class="field-label">Device label (override)</div>
              <input id="deviceOverrideInput" class="text-input" placeholder="Optional custom codename" />
            </div>
            <div class="button-row">
              <button class="btn" id="applySettingsBtn">Apply</button>
              <button class="btn btn-secondary" id="resetSettingsBtn">Reset</button>
            </div>
          </div>
        </div>
      </div>

      <div class="floating-card">
        <div class="floating-title">Coffee Game Status</div>
        <div class="floating-body" id="floatingBody">
          Waiting for connection…
        </div>
        <div class="floating-tag-row">
          <div class="badge" id="badgeTransport">Transport: —</div>
          <div class="badge" id="badgeRoom">Room: none</div>
        </div>
      </div>
    </div>

    <div class="right-pane">
      <div class="log-panel">
        <div class="log-header">
          <span>Event Log</span>
          <span class="tag" id="logTag">Idle</span>
        </div>
        <div class="log-body" id="logBody"></div>
        <div class="chat-input-row">
          <input id="chatInput" class="chat-input" placeholder="Send a message to the room…" />
          <button class="btn btn-secondary" id="chatSendBtn" style="flex:0 0 auto;padding-inline:10px;">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Socket.IO from CDN -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"
          integrity="sha384-3tqvZkqvZp7vX8p9uXG3p1zvQv7uG3Zp7vX8p9uXG3p1zvQv7uG3Zp7vX8p9uXG"
          crossorigin="anonymous"></script>

  <script>
    // ===== Device detection with codenames =====
    function detectAndroidCodename() {
      let ua = navigator.userAgent || "";
      let uaData = navigator.userAgentData || null;

      // Try UA-CH first (more honest on some spoofing browsers)
      let androidVersion = null;
      if (uaData && uaData.platform && uaData.platform.toLowerCase().includes("android")) {
        try {
          // Some browsers expose platformVersion like "9", "10", "11"
          if (uaData.platformVersion) {
            androidVersion = parseInt(uaData.platformVersion.split(".")[0], 10);
          }
        } catch (e) {
          androidVersion = null;
        }
      }

      // Fallback: parse classic UA
      if (!androidVersion) {
        let match = ua.match(/Android\s+([0-9]+)(?:\.[0-9]+)?/i);
        if (match) {
          androidVersion = parseInt(match[1], 10);
        }
      }

      if (!androidVersion) {
        return "Unknown Device";
      }

      // Map to dessert codenames
      let codename = null;
      switch (androidVersion) {
        case 9:
          codename = "Pie";
          break;
        case 10:
          codename = "Quince Tart";
          break;
        case 11:
          codename = "Red Velvet Cake";
          break;
        case 12:
          codename = "Snow Cone";
          break;
        case 13:
          codename = "Tiramisu";
          break;
        case 14:
          codename = "Upside Down Cake";
          break;
        default:
          codename = "Android " + androidVersion;
      }

      return "Android " + androidVersion + " (" + codename + ")";
    }

    function updateDeviceLabel() {
      const pill = document.getElementById("deviceLabel");
      const overrideInput = document.getElementById("deviceOverrideInput");
      const override = overrideInput.value.trim();
      if (override) {
        pill.textContent = override;
        return;
      }
      pill.textContent = detectAndroidCodename();
    }

    // ===== Simple canvas animation (ambient) =====
    function startCanvasLoop() {
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");

      function resize() {
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * window.devicePixelRatio;
        canvas.height = rect.height * window.devicePixelRatio;
        ctx.setTransform(window.devicePixelRatio, 0, 0, window.devicePixelRatio, 0, 0);
      }
      window.addEventListener("resize", resize);
      resize();

      let t = 0;
      function loop() {
        t += 0.016;
        const w = canvas.width / window.devicePixelRatio;
        const h = canvas.height / window.devicePixelRatio;

        ctx.clearRect(0, 0, w, h);

        // Background gradient
        const g = ctx.createRadialGradient(w * 0.3, h * 0.1, 10, w * 0.5, h * 0.8, Math.max(w, h));
        g.addColorStop(0, "#5b3a28");
        g.addColorStop(1, "#120b08");
        ctx.fillStyle = g;
        ctx.fillRect(0, 0, w, h);

        // Floating beans
        const beans = 18;
        for (let i = 0; i < beans; i++) {
          const phase = t * 0.4 + i * 0.7;
          const x = (i / beans) * w + Math.sin(phase) * 20;
          const y = (0.2 + 0.6 * ((i % 5) / 5)) * h + Math.cos(phase * 1.3) * 10;
          const r = 6 + 2 * Math.sin(phase * 1.7);

          ctx.save();
          ctx.translate(x, y);
          ctx.rotate(Math.sin(phase * 1.2) * 0.6);
          ctx.fillStyle = "rgba(200,155,109,0.9)";
          ctx.beginPath();
          ctx.ellipse(0, 0, r * 1.4, r, 0, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }

        requestAnimationFrame(loop);
      }
      loop();
    }

    // ===== UI tab switching =====
    function setupTabs() {
      const tabs = document.querySelectorAll(".menu-tab");
      const sections = {
        host: document.getElementById("section-host"),
        join: document.getElementById("section-join"),
        settings: document.getElementById("section-settings"),
      };

      tabs.forEach(tab => {
        tab.addEventListener("click", () => {
          tabs.forEach(t => t.classList.remove("active"));
          tab.classList.add("active");
          const key = tab.getAttribute("data-tab");
          Object.keys(sections).forEach(k => {
            sections[k].classList.toggle("active", k === key);
          });
        });
      });
    }

    // ===== Logging =====
    function log(message, strong = false) {
      const body = document.getElementById("logBody");
      const line = document.createElement("div");
      line.className = "log-line" + (strong ? " log-line-strong" : "");
      const ts = new Date().toLocaleTimeString();
      line.textContent = "[" + ts + "] " + message;
      body.appendChild(line);
      body.scrollTop = body.scrollHeight;
    }

    function setLogTag(text) {
      document.getElementById("logTag").textContent = text;
    }

    // ===== Socket.IO setup (HTTPS) =====
    let socket = null;
    let currentRoomId = null;
    let currentRoomName = null;
    let currentGameId = null;
    let lastPingSent = null;
    let pingInterval = null;

    function connectSocket() {
      const statusDot = document.getElementById("statusDot");
      const statusText = document.getElementById("statusText");
      const floatingBody = document.getElementById("floatingBody");
      const badgeTransport = document.getElementById("badgeTransport");

      log("Connecting to Coffee Game server (HTTPS)…");
      setLogTag("Connecting…");
      statusDot.classList.remove("online");
      statusText.textContent = "Connecting…";

      socket = io("https://c3l3st1n3k1w1.onrender.com", {
        transports: ["polling", "websocket"],
        reconnection: true,
        reconnectionAttempts: Infinity,
        reconnectionDelay: 1000,
        reconnectionDelayMax: 5000,
      });

      socket.on("connect", () => {
        statusDot.classList.add("online");
        statusText.textContent = "Online";
        floatingBody.textContent = "Connected. Host or join a room to start roasting.";
        badgeTransport.textContent = "Transport: " + socket.io.engine.transport.name;
        log("Connected to server. Socket ID: " + socket.id, true);
        setLogTag("Online");

        // Start ping
        if (pingInterval) clearInterval(pingInterval);
        pingInterval = setInterval(() => {
          if (!socket || !socket.connected) return;
          lastPingSent = performance.now();
          socket.emit("pingCheck");
        }, 5000);
      });

      socket.on("disconnect", (reason) => {
        statusDot.classList.remove("online");
        statusText.textContent = "Offline";
        floatingBody.textContent = "Disconnected: " + reason;
        badgeTransport.textContent = "Transport: —";
        log("Disconnected: " + reason, true);
        setLogTag("Offline");
        if (pingInterval) {
          clearInterval(pingInterval);
          pingInterval = null;
        }
      });

      socket.on("connect_error", (err) => {
        log("Connection error: " + err.message, true);
        floatingBody.textContent = "Connection error: " + err.message;
        setLogTag("Error");
      });

      socket.on("pongCheck", () => {
        if (lastPingSent != null) {
          const rtt = Math.round(performance.now() - lastPingSent);
          document.getElementById("pingPill").textContent = "Ping: " + rtt + " ms";
        }
      });

      // Rooms list
      socket.on("roomsList", (rooms) => {
        updateRoomsList(rooms || []);
      });

      // Room joined
      socket.on("roomJoined", (payload) => {
        currentRoomId = payload.roomId;
        currentRoomName = payload.roomName;
        currentGameId = payload.gameId;
        updateRoomUI();
        log("Joined room: " + payload.roomName + " (" + payload.roomId + ")", true);
      });

      // Room left
      socket.on("roomLeft", () => {
        currentRoomId = null;
        currentRoomName = null;
        currentGameId = null;
        updateRoomUI();
        log("Left room.", true);
      });

      // Player count update
      socket.on("roomPlayerCount", (count) => {
        document.getElementById("playerCountPill").textContent = "Players: " + count;
      });

      // Chat
      socket.on("chatMessage", (msg) => {
        log(msg.sender + ": " + msg.text);
      });
    }

    // ===== Rooms UI =====
    function updateRoomsList(rooms) {
      const list = document.getElementById("roomsList");
      const empty = document.getElementById("roomsEmptyState");
      list.innerHTML = "";
      if (!rooms || rooms.length === 0) {
        empty.classList.remove("hidden");
        list.appendChild(empty);
        return;
      }
      empty.classList.add("hidden");

      rooms.forEach(room => {
        const item = document.createElement("div");
        item.className = "room-item";

        const meta = document.createElement("div");
        meta.className = "room-meta";

        const name = document.createElement("div");
        name.className = "room-name";
        name.textContent = room.name || "Unnamed Room";

        const sub = document.createElement("div");
        sub.className = "room-sub";
        sub.textContent = (room.gameId || "unknown") + " • " +
          (room.playerCount || 0) + " player" + ((room.playerCount || 0) === 1 ? "" : "s");

        meta.appendChild(name);
        meta.appendChild(sub);

        const joinBtn = document.createElement("button");
        joinBtn.className = "room-join-btn";
        joinBtn.textContent = "Join";
        joinBtn.addEventListener("click", () => {
          joinRoom(room.id);
        });

        item.appendChild(meta);
        item.appendChild(joinBtn);
        list.appendChild(item);
      });
    }

    function updateRoomUI() {
      const roomInfo = document.getElementById("roomInfo");
      const roomModePill = document.getElementById("roomModePill");
      const badgeRoom = document.getElementById("badgeRoom");
      const hostBtn = document.getElementById("hostBtn");
      const leaveBtn = document.getElementById("leaveBtn");

      if (currentRoomId) {
        roomInfo.textContent = "In room: " + currentRoomName + " (" + currentRoomId + ")";
        roomModePill.textContent = "In Room";
        badgeRoom.textContent = "Room: " + currentRoomName;
        leaveBtn.disabled = false;
        hostBtn.disabled = true;
      } else {
        roomInfo.textContent = "Not in a room";
        roomModePill.textContent = "No Room";
        badgeRoom.textContent = "Room: none";
        leaveBtn.disabled = true;
        hostBtn.disabled = false;
        document.getElementById("playerCountPill").textContent = "Players: 0";
      }
    }

    // ===== Host / Join actions =====
    function hostRoom() {
      if (!socket || !socket.connected) {
        log("Cannot host: not connected.", true);
        return;
      }
      const nameInput = document.getElementById("hostRoomName");
      const gameSelect = document.getElementById("hostGameSelect");
      const displayNameInput = document.getElementById("displayNameInput");

      const roomName = nameInput.value.trim() || "Coffee Room";
      const gameId = gameSelect.value || "snake";
      const displayName = displayNameInput.value.trim() || "Guest";

      socket.emit("hostRoom", {
        roomName,
        gameId,
        displayName,
      });

      log("Hosting room: " + roomName + " (" + gameId + ")");
      setLogTag("Hosting");
    }

    function joinRoom(roomId) {
      if (!socket || !socket.connected) {
        log("Cannot join: not connected.", true);
        return;
      }
      const displayNameInput = document.getElementById("displayNameInput");
      const displayName = displayNameInput.value.trim() || "Guest";

      socket.emit("joinRoom", {
        roomId,
        displayName,
      });

      log("Joining room: " + roomId);
      setLogTag("Joining");
    }

    function leaveRoom() {
      if (!socket || !socket.connected) {
        log("Cannot leave: not connected.", true);
        return;
      }
      if (!currentRoomId) {
        log("Not in a room.");
        return;
      }
      socket.emit("leaveRoom");
      log("Requested to leave room.");
      setLogTag("Leaving");
    }

    function refreshRooms() {
      if (!socket || !socket.connected) {
        log("Cannot refresh rooms: not connected.", true);
        return;
      }
      socket.emit("listRooms");
      log("Requested rooms list.");
      setLogTag("Listing Rooms");
    }

    // ===== Chat =====
    function sendChat() {
      if (!socket || !socket.connected) {
        log("Cannot send chat: not connected.", true);
        return;
      }
      if (!currentRoomId) {
        log("Cannot send chat: not in a room.", true);
        return;
      }
      const input = document.getElementById("chatInput");
      const text = input.value.trim();
      if (!text) return;
      socket.emit("chatMessage", { text });
      input.value = "";
    }

    // ===== Settings =====
    function applySettings() {
      updateDeviceLabel();
      log("Settings applied.");
    }

    function resetSettings() {
      document.getElementById("displayNameInput").value = "";
      document.getElementById("deviceOverrideInput").value = "";
      updateDeviceLabel();
      log("Settings reset.");
    }

    // ===== Init =====
    window.addEventListener("DOMContentLoaded", () => {
      setupTabs();
      startCanvasLoop();
      updateDeviceLabel();
      connectSocket();

      document.getElementById("hostBtn").addEventListener("click", hostRoom);
      document.getElementById("leaveBtn").addEventListener("click", leaveRoom);
      document.getElementById("refreshRoomsBtn").addEventListener("click", refreshRooms);
      document.getElementById("applySettingsBtn").addEventListener("click", applySettings);
      document.getElementById("resetSettingsBtn").addEventListener("click", resetSettings);
      document.getElementById("chatSendBtn").addEventListener("click", sendChat);
      document.getElementById("chatInput").addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendChat();
      });
    });
  </script>
</body>
</html>
